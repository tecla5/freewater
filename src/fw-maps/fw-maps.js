function changeToArray(a){var e=[];if(a)for(var s in a)e.push(a[s]);return e}function search(a,e){for(var s=0;s<a.length;s++)if(a[s]===e)return a[s];return null}function userDontHaveOpinion(a,e){console.log("mark.confirms",a.confirms),console.log("mark.complaints",a.complaints),console.log("userId",e);var s=search(a.confirms,e);return s||(s=search(a.complaints,e)),console.log("found",s),!s}Polymer({is:"fw-maps",properties:{usersReady:Boolean,marks:{type:Array,observer:"loadMarksToMap"}},observers:["loadMarksToMap(marks, usersReady)"],ready:function(){console.log("ready fw-map");var a=this;this.marksdataSource=firebase.app("fw").database().ref("marks"),this.$$("smart-map").addEventListener("country-changed",this.loadMarks.bind(this)),this.$$("smart-map").addEventListener("publish",this.publish.bind(this)),this.$$("smart-map").addEventListener("confirm",function(e){a.addOpinion("confirms",e)}),this.$$("smart-map").addEventListener("complaint",function(e){a.addOpinion("complaints",e)})},addOpinion:function(a,e){var s="Yo have to login to confirm or deny a water point";this.checkLogin(s).then(function(s){var r=e.detail.mark;if(userDontHaveOpinion(r,s.id)){var o=firebase.app("fw").database().ref("marks/"+r.__firebaseKey__),n=null;o.child(a),n||(n=[]),n.push(s.id);var i={};i[a]=n,o.update(i)}})},loadMarks:function(a){var e=a.detail.country;console.log("country",e);var s=this;this.marksdataSource.orderByChild("country").equalTo(e).on("value",function(a){s.marks=a.val(),"block"===s.$$(".progress-panel").style.display&&s.hideProgressbar()},function(a){console.log("The read failed: "+a.code)}),this.$$(".map-panel").style.height="100%"},hideProgressbar:function(){this.$$(".progress-panel").style.display="none"},loadMarksToMap:function(){var a=this.$$("firebase-login"),e=this.$$("freewater-users"),s=[];for(var r in this.marks){var o=this.marks[r];o.__firebaseKey__=r,o.createdDate=moment(o.createdDate).format("MMMM Do YYYY, h:mm:ss a"),o.confirms=changeToArray(o.confirms),o.complaints=changeToArray(o.complaints);var n=e.getUser(o.user);o.user=n,a&&a.user&&(o.gaveOpinion=!userDontHaveOpinion(o,a.user.id)),console.log("mark.gaveOpinion",o.gaveOpinion),s.push(this.marks[r])}this.$$("smart-map").marks=s},publish:function(a){this.marksdataSource.push(a);var e=this,s="Yo have to login to publish a water point";this.checkLogin(s).then(function(s){e.publishByLoggedUser(a,s)})},checkLogin:function(a){var e=this;return new Promise(function(s){var r=e.$$("firebase-login");r.message=a;var o=r.user;o?s(o):r.showLoginDialog().then(function(a){console.log("User",a),s(a)},function(a){console.error("login failed",a)})})},publishByLoggedUser:function(a,e){var s;console.log("data.detail",a.detail),s=a.detail?a.detail:a,s.user=e.id,this.marksdataSource.push(s),this.$$("smart-map").successRegisterMessage="Publish successfully"}});