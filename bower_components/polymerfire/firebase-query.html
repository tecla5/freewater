<html><head><link rel="import" href="../polymer/polymer.html">
<link rel="import" href="firebase-database-behavior.html">
<link rel="import" href="firebase.html">



</head><body><dom-module id="firebase-query">
  <script>!function(){"use strict";Polymer({is:"firebase-query",behaviors:[Polymer.FirebaseDatabaseBehavior],properties:{query:{type:Object,computed:"__computeQuery(ref, orderByChild, limitToFirst, limitToLast, startAt, endAt, equalTo)",observer:"__queryChanged"},orderByChild:{type:String,value:""},startAt:{type:String,value:""},endAt:{type:String,value:""},equalTo:{type:Object,value:null},limitToFirst:{type:Number,value:0},limitToLast:{type:Number,value:0}},created:function(){this.__map={}},attached:function(){this.__queryChanged(this.query,this.query)},detached:function(){null!=this.query&&this.query.off()},child:function(t){return this.__map[t]},get isNew(){return this.disabled||!this.__pathReady(this.path)},get zeroValue(){return[]},memoryPathToStoragePath:function(t){var e=this.path;if("data"!==t){var i=t.split("."),a=window.parseInt(i[1],10);null==a||isNaN(a)||(i[1]=null!=this.data[a]&&this.data[a].$key),e+=i.join("/").replace(/^data\.?/,"")}return e},storagePathToMemoryPath:function(t){var e="data";if(t!==this.path){var i=t.replace(this.path+"/","").split("/"),a=i[0],r=this.__map[a];r&&(i[0]=this.__indexFromKey(a)),e+="."+i.join(".")}return e},setStoredValue:function(t,e){return t===this.path||/\$key$/.test(t)?Promise.resolve():this._setFirebaseValue(t,e)},_propertyToKey:function(t){var e=window.parseInt(t,10);if(null!=e&&!isNaN(e))return this.data[e].$key},__computeQuery:function(t,e,i,a,r,s,n){if(null==t)return null;var o;return o=e?t.orderByChild(e):t.orderByKey(),i?o=o.limitToFirst(i):a&&(o=o.limitToLast(a)),r&&(o=o.startAt(r)),s&&(o=o.endAt(s)),n&&(o=o.equalTo(n)),o},__queryChanged:function(t,e){e&&(e.off(),this.syncToMemory(function(){this.set("data",this.zeroValue)})),t&&(t.on("child_added",this.__onFirebaseChildAdded,this.__onError,this),t.on("child_removed",this.__onFirebaseChildRemoved,this.__onError,this),t.on("child_changed",this.__onFirebaseChildChanged,this.__onError,this),t.on("child_moved",this.__onFirebaseChildMoved,this.__onError,this))},__indexFromKey:function(t){for(var e=0;e<this.data.length;e++)if(this.data[e].$key===t)return e;return-1},__onFirebaseChildAdded:function(t){var e=t.val(),i=t.key;this._log("Firebase child_added:",i,e),e.$key=i,this.__map[i]=e,this.push("data",e)},__onFirebaseChildRemoved:function(t){var e=t.key,i=this.__map[e];this._log("Firebase child_removed:",e,i),i&&(this.__map[e]=null,this.async(function(){this.syncToMemory(function(){this.splice("data",this.__indexFromKey(e),1)})}))},__onFirebaseChildChanged:function(t){var e=t.key,i=this.__map[e];this._log("Firebase child_changed:",e,i),i&&this.async(function(){var a=this.__indexFromKey(e),r=t.val();r.$key=e,this.__map[e]=r,this.syncToMemory(function(){if(r instanceof Object){for(var t in r)this.set(["data",a,t],r[t]);for(var t in i)r.hasOwnProperty(t)||this.set(["data",a,t],void 0)}else this.set(["data",a],r)})})},__onFirebaseChildMoved:function(t,e){var i=t.key,a=this.__map[i],r=e?this.__indexFromKey(e):0;if(this._log("Firebase child_moved:",i,a,"to index",r),a){var s=this.__indexFromKey(i);a=t.val(),a.$key=i,this.__map[i]=a,this.async(function(){this.syncToMemory(function(){this.splice("data",s,1),this.splice("data",r,0,a)})})}}})}();</script>
</dom-module>
</body></html>